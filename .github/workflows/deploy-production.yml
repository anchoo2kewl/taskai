name: Deploy to Production

on:
  push:
    branches: [ production ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy (branch, tag, or commit SHA)'
        required: true
        default: 'main'

env:
  GO_VERSION: "1.24"
  NODE_VERSION: "20"

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

  deploy-production:
    needs: security-scan
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}
          fetch-depth: 0

      - name: Set version information
        id: version
        run: |
          VERSION=$(cat VERSION 2>/dev/null || echo "dev")
          GIT_COMMIT=${GITHUB_SHA::7}
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "GIT_COMMIT=$GIT_COMMIT" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT

          echo "ðŸ·ï¸  Version: $VERSION"
          echo "ðŸ“ Commit: $GIT_COMMIT"
          echo "ðŸ• Build Time: $BUILD_TIME"

      - name: Deploy to Production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          COMMIT_SHA: ${{ github.sha }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          GIT_COMMIT: ${{ steps.version.outputs.GIT_COMMIT }}
          BUILD_TIME: ${{ steps.version.outputs.BUILD_TIME }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan 31.97.102.48 >> ~/.ssh/known_hosts

          echo "ðŸš€ Deploying TaskAI to Production..."

          ssh -i ~/.ssh/deploy_key ubuntu@31.97.102.48 << 'ENDSSH'
            set -ex
            echo "ðŸ“‚ Changing to source directory..."
            cd /home/ubuntu/taskai/source

            echo "ðŸ“¥ Fetching from origin..."
            git fetch origin

            echo "ðŸ”„ Resetting to commit: $COMMIT_SHA"
            git reset --hard "$COMMIT_SHA"

            echo "ðŸ“‚ Moving to parent directory..."
            cd ..

            echo "ðŸ“Œ Setting version info..."
            export VERSION='$VERSION'
            export GIT_COMMIT='$GIT_COMMIT'
            export BUILD_TIME='$BUILD_TIME'
            echo "Version: $VERSION, Commit: $GIT_COMMIT, Build Time: $BUILD_TIME"

            echo "ðŸ›‘ Stopping containers..."
            docker compose down || true

            echo "ðŸ§¹ Cleaning up Docker build cache and unused images..."
            docker builder prune -af || true
            docker image prune -af || true

            echo "ðŸ”¨ Building containers..."
            docker compose build --build-arg VERSION="$VERSION" --build-arg GIT_COMMIT="$GIT_COMMIT" --build-arg BUILD_TIME="$BUILD_TIME"

            echo "ðŸš€ Starting containers..."
            docker compose up -d

            echo "â³ Waiting for containers to be healthy..."
            sleep 15

            echo "ðŸ“Š Container status:"
            docker compose ps
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 10
          curl -f https://taskai.cc/api/health || exit 1
          echo "âœ… Production deployed successfully"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Production Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** 31.97.102.48" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://taskai.cc" >> $GITHUB_STEP_SUMMARY
