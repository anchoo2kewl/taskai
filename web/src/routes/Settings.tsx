import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import Card from '../components/ui/Card'
import Button from '../components/ui/Button'
import TextInput from '../components/ui/TextInput'
import FormError from '../components/ui/FormError'
import { apiClient, type CloudinaryCredentialResponse, type APIKey, type Team, type TeamMember, type TeamInvitation, type Invite } from '../lib/api'

export default function Settings() {
  const navigate = useNavigate()

  // Password change state
  const [currentPassword, setCurrentPassword] = useState('')
  const [newPassword, setNewPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')
  const [passwordError, setPasswordError] = useState('')
  const [passwordSuccess, setPasswordSuccess] = useState('')
  const [isChangingPassword, setIsChangingPassword] = useState(false)

  // 2FA state
  const [twoFAEnabled, setTwoFAEnabled] = useState(false)
  const [twoFASecret, setTwoFASecret] = useState('')
  const [qrCodeURL, setQrCodeURL] = useState('')
  const [verificationCode, setVerificationCode] = useState('')
  const [backupCodes, setBackupCodes] = useState<string[]>([])
  const [twoFAError, setTwoFAError] = useState('')
  const [twoFASuccess, setTwoFASuccess] = useState('')
  const [isSettingUp2FA, setIsSettingUp2FA] = useState(false)
  const [isEnabling2FA, setIsEnabling2FA] = useState(false)
  const [showBackupCodes, setShowBackupCodes] = useState(false)
  const [disablePassword, setDisablePassword] = useState('')
  const [isDisabling2FA, setIsDisabling2FA] = useState(false)

  // API Keys state
  const [apiKeys, setApiKeys] = useState<APIKey[]>([])
  const [newKeyName, setNewKeyName] = useState('')
  const [newKeyExpires, setNewKeyExpires] = useState<number | undefined>(90)
  const [createdKey, setCreatedKey] = useState<{ key: string; name: string } | null>(null)
  const [apiKeyError, setApiKeyError] = useState('')
  const [apiKeySuccess, setApiKeySuccess] = useState('')
  const [copiedSnippet, setCopiedSnippet] = useState<string | null>(null)
  const [isCreatingKey, setIsCreatingKey] = useState(false)
  const [isDeletingKey, setIsDeletingKey] = useState<number | null>(null)

  // Cloudinary state
  const [cloudName, setCloudName] = useState('')
  const [cloudAPIKey, setCloudAPIKey] = useState('')
  const [cloudAPISecret, setCloudAPISecret] = useState('')
  const [cloudMaxSize, setCloudMaxSize] = useState(10)
  const [hasCloudinaryCredentials, setHasCloudinaryCredentials] = useState(false)
  const [cloudinaryError, setCloudinaryError] = useState('')
  const [cloudinarySuccess, setCloudinarySuccess] = useState('')
  const [isSavingCloudinary, setIsSavingCloudinary] = useState(false)
  const [isDeletingCloudinary, setIsDeletingCloudinary] = useState(false)
  const [cloudinaryStatus, setCloudinaryStatus] = useState<'unknown' | 'connected' | 'error' | 'suspended'>('unknown')
  const [cloudinaryLastChecked, setCloudinaryLastChecked] = useState<string | null>(null)
  const [cloudinaryLastError, setCloudinaryLastError] = useState('')
  const [cloudinaryConsecutiveFailures, setCloudinaryConsecutiveFailures] = useState(0)
  const [isTestingCloudinary, setIsTestingCloudinary] = useState(false)

  // Team Management state
  const [team, setTeam] = useState<Team | null>(null)
  const [teamMembers, setTeamMembers] = useState<TeamMember[]>([])
  const [invitations, setInvitations] = useState<TeamInvitation[]>([])
  const [inviteEmail, setInviteEmail] = useState('')
  const [teamError, setTeamError] = useState('')
  const [teamSuccess, setTeamSuccess] = useState('')
  const [isInviting, setIsInviting] = useState(false)
  const [isRemovingMember, setIsRemovingMember] = useState<number | null>(null)
  const [isRespondingToInvitation, setIsRespondingToInvitation] = useState<number | null>(null)

  // Invite system state
  const [myInvites, setMyInvites] = useState<Invite[]>([])
  const [myInviteCount, setMyInviteCount] = useState(0)
  const [isUserAdmin, setIsUserAdmin] = useState(false)
  const [isCreatingInvite, setIsCreatingInvite] = useState(false)
  const [inviteError, setInviteError] = useState('')
  const [inviteSuccess, setInviteSuccess] = useState('')
  const [newInviteCode, setNewInviteCode] = useState('')
  const [inviteRecipientEmail, setInviteRecipientEmail] = useState('')

  useEffect(() => {
    load2FAStatus()
    loadAPIKeys()
    loadTeamData()
    loadCloudinaryCredentials()
    loadInvites()
  }, [])

  const load2FAStatus = async () => {
    try {
      const status = await apiClient.get2FAStatus()
      setTwoFAEnabled(status.enabled)
    } catch (error) {
      console.error('Failed to load 2FA status:', error)
    }
  }

  const handlePasswordChange = async (e: React.FormEvent) => {
    e.preventDefault()
    setPasswordError('')
    setPasswordSuccess('')

    if (newPassword !== confirmPassword) {
      setPasswordError('Passwords do not match')
      return
    }

    if (newPassword.length < 8) {
      setPasswordError('Password must be at least 8 characters')
      return
    }

    setIsChangingPassword(true)

    try {
      await apiClient.changePassword({
        current_password: currentPassword,
        new_password: newPassword,
      })

      setPasswordSuccess('Password changed successfully')
      setCurrentPassword('')
      setNewPassword('')
      setConfirmPassword('')
    } catch (error: unknown) {
      setPasswordError(error instanceof Error ? error.message : 'Failed to change password')
    } finally {
      setIsChangingPassword(false)
    }
  }

  const handleSetup2FA = async () => {
    setTwoFAError('')
    setIsSettingUp2FA(true)

    try {
      const response = await apiClient.setup2FA()
      setTwoFASecret(response.secret)
      setQrCodeURL(response.qr_code_url)
      setShowBackupCodes(false)
    } catch (error: unknown) {
      setTwoFAError(error instanceof Error ? error.message : 'Failed to setup 2FA')
    } finally {
      setIsSettingUp2FA(false)
    }
  }

  const handleEnable2FA = async (e: React.FormEvent) => {
    e.preventDefault()
    setTwoFAError('')
    setTwoFASuccess('')

    if (!verificationCode || verificationCode.length !== 6) {
      setTwoFAError('Please enter a 6-digit verification code')
      return
    }

    setIsEnabling2FA(true)

    try {
      const response = await apiClient.enable2FA({ code: verificationCode })
      setBackupCodes(response.backup_codes)
      setShowBackupCodes(true)
      setTwoFAEnabled(true)
      setTwoFASuccess('2FA enabled successfully! Save your backup codes.')
      setVerificationCode('')
      setQrCodeURL('')
      setTwoFASecret('')
    } catch (error: unknown) {
      setTwoFAError(error instanceof Error ? error.message : 'Invalid verification code')
    } finally {
      setIsEnabling2FA(false)
    }
  }

  const handleDisable2FA = async (e: React.FormEvent) => {
    e.preventDefault()
    setTwoFAError('')
    setTwoFASuccess('')

    if (!disablePassword) {
      setTwoFAError('Password is required to disable 2FA')
      return
    }

    setIsDisabling2FA(true)

    try {
      await apiClient.disable2FA({ password: disablePassword })
      setTwoFAEnabled(false)
      setTwoFASuccess('2FA disabled successfully')
      setDisablePassword('')
      setBackupCodes([])
      setShowBackupCodes(false)
    } catch (error: unknown) {
      setTwoFAError(error instanceof Error ? error.message : 'Failed to disable 2FA')
    } finally {
      setIsDisabling2FA(false)
    }
  }

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text)
  }

  const copyAllBackupCodes = () => {
    const allCodes = backupCodes.join('\n')
    copyToClipboard(allCodes)
    setTwoFASuccess('All backup codes copied to clipboard')
  }

  const copySecret = () => {
    copyToClipboard(twoFASecret)
    setTwoFASuccess('Secret key copied to clipboard')
  }

  const applyCloudinaryHealth = (cred: CloudinaryCredentialResponse) => {
    setCloudinaryStatus(cred.status)
    setCloudinaryLastChecked(cred.last_checked_at)
    setCloudinaryLastError(cred.last_error)
    setCloudinaryConsecutiveFailures(cred.consecutive_failures)
  }

  const loadCloudinaryCredentials = async () => {
    try {
      const cred = await apiClient.getCloudinaryCredential()
      if (cred) {
        setCloudName(cred.cloud_name)
        setCloudAPIKey(cred.api_key)
        setCloudMaxSize(cred.max_file_size_mb || 10)
        setHasCloudinaryCredentials(true)
        applyCloudinaryHealth(cred)

        // Auto-test if last check was > 24h ago and not suspended
        if (cred.status !== 'suspended') {
          const lastCheck = cred.last_checked_at ? new Date(cred.last_checked_at).getTime() : 0
          const dayAgo = Date.now() - 24 * 60 * 60 * 1000
          if (lastCheck < dayAgo) {
            handleTestCloudinary()
          }
        }
      }
    } catch (error) {
      console.error('Failed to load Cloudinary credentials:', error)
    }
  }

  const handleSaveCloudinary = async (e: React.FormEvent) => {
    e.preventDefault()
    setCloudinaryError('')
    setCloudinarySuccess('')

    if (!cloudName.trim() || !cloudAPIKey.trim() || !cloudAPISecret.trim()) {
      setCloudinaryError('All fields are required')
      return
    }

    setIsSavingCloudinary(true)
    try {
      const cred = await apiClient.saveCloudinaryCredential({
        cloud_name: cloudName.trim(),
        api_key: cloudAPIKey.trim(),
        api_secret: cloudAPISecret.trim(),
        max_file_size_mb: cloudMaxSize,
      })
      setHasCloudinaryCredentials(true)
      setCloudAPISecret('')
      applyCloudinaryHealth(cred)

      if (cred.status === 'connected') {
        setCloudinarySuccess('Credentials saved and connection verified')
      } else {
        setCloudinarySuccess('Credentials saved')
        setCloudinaryError(cred.last_error || 'Connection test failed')
      }
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : 'Failed to save credentials'
      setCloudinaryError(message)
    } finally {
      setIsSavingCloudinary(false)
    }
  }

  const handleTestCloudinary = async () => {
    setIsTestingCloudinary(true)
    setCloudinaryError('')
    setCloudinarySuccess('')
    try {
      const cred = await apiClient.testCloudinaryConnection()
      applyCloudinaryHealth(cred)
      if (cred.status === 'connected') {
        setCloudinarySuccess('Connection verified')
      } else {
        setCloudinaryError(cred.last_error || 'Connection test failed')
      }
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : 'Failed to test connection'
      setCloudinaryError(message)
    } finally {
      setIsTestingCloudinary(false)
    }
  }

  const handleDeleteCloudinary = async () => {
    if (!confirm('Are you sure you want to remove your Cloudinary credentials?')) return

    setIsDeletingCloudinary(true)
    setCloudinaryError('')
    setCloudinarySuccess('')
    try {
      await apiClient.deleteCloudinaryCredential()
      setCloudName('')
      setCloudAPIKey('')
      setCloudAPISecret('')
      setCloudMaxSize(10)
      setHasCloudinaryCredentials(false)
      setCloudinaryStatus('unknown')
      setCloudinaryLastChecked(null)
      setCloudinaryLastError('')
      setCloudinaryConsecutiveFailures(0)
      setCloudinarySuccess('Cloudinary credentials removed')
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : 'Failed to remove credentials'
      setCloudinaryError(message)
    } finally {
      setIsDeletingCloudinary(false)
    }
  }

  const loadInvites = async () => {
    try {
      const data = await apiClient.getInvites()
      setMyInvites(data.invites || [])
      setMyInviteCount(data.invite_count)
      setIsUserAdmin(data.is_admin)
    } catch (error) {
      console.error('Failed to load invites:', error)
    }
  }

  const handleCreateInviteCode = async () => {
    setInviteError('')
    setInviteSuccess('')
    setNewInviteCode('')
    setIsCreatingInvite(true)

    try {
      const email = inviteRecipientEmail.trim() || undefined
      const result = await apiClient.createInvite(email)
      setNewInviteCode(result.code)
      if (result.email_sent && email) {
        setInviteSuccess(`Invite created and email sent to ${email}!`)
      } else {
        setInviteSuccess('Invite created! Share the link below.')
      }
      setInviteRecipientEmail('')
      await loadInvites()
    } catch (error: unknown) {
      setInviteError(error instanceof Error ? error.message : 'Failed to create invite')
    } finally {
      setIsCreatingInvite(false)
    }
  }

  const copyInviteLink = (code: string) => {
    const url = `${window.location.origin}/signup?code=${code}`
    navigator.clipboard.writeText(url)
    setInviteSuccess('Invite link copied to clipboard')
  }

  const loadAPIKeys = async () => {
    try {
      const keys = await apiClient.getAPIKeys()
      setApiKeys(keys)
    } catch (error) {
      console.error('Failed to load API keys:', error)
    }
  }

  const handleCreateAPIKey = async (e: React.FormEvent) => {
    e.preventDefault()
    setApiKeyError('')
    setApiKeySuccess('')

    if (!newKeyName.trim()) {
      setApiKeyError('Key name is required')
      return
    }

    setIsCreatingKey(true)

    try {
      const response = await apiClient.createAPIKey({
        name: newKeyName,
        expires_in: newKeyExpires,
      })

      setCreatedKey({ key: response.key, name: response.name })
      setApiKeySuccess('API key created successfully')
      setNewKeyName('')
      setNewKeyExpires(90)
      await loadAPIKeys()
    } catch (error: unknown) {
      setApiKeyError(error instanceof Error ? error.message : 'Failed to create API key')
    } finally {
      setIsCreatingKey(false)
    }
  }

  const handleDeleteAPIKey = async (id: number, name: string) => {
    if (!confirm(`Are you sure you want to delete the API key "${name}"?`)) {
      return
    }

    setIsDeletingKey(id)
    setApiKeyError('')
    setApiKeySuccess('')

    try {
      await apiClient.deleteAPIKey(id)
      setApiKeySuccess('API key deleted successfully')
      await loadAPIKeys()
    } catch (error: unknown) {
      setApiKeyError(error instanceof Error ? error.message : 'Failed to delete API key')
    } finally {
      setIsDeletingKey(null)
    }
  }

  const copyAPIKey = (key: string) => {
    copyToClipboard(key)
    setApiKeySuccess('API key copied to clipboard')
  }

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString()
  }

  const loadTeamData = async () => {
    try {
      const [teamData, membersData, invitationsData] = await Promise.all([
        apiClient.getMyTeam(),
        apiClient.getTeamMembers(),
        apiClient.getMyInvitations(),
      ])
      setTeam(teamData)
      setTeamMembers(membersData)
      setInvitations(invitationsData)
    } catch (error) {
      console.error('Failed to load team data:', error)
    }
  }

  const handleInviteMember = async (e: React.FormEvent) => {
    e.preventDefault()
    setTeamError('')
    setTeamSuccess('')

    if (!inviteEmail.trim()) {
      setTeamError('Email is required')
      return
    }

    setIsInviting(true)

    try {
      await apiClient.inviteTeamMember(inviteEmail)
      setTeamSuccess(`Invitation sent to ${inviteEmail}`)
      setInviteEmail('')
      await loadTeamData()
    } catch (error: unknown) {
      setTeamError(error instanceof Error ? error.message : 'Failed to send invitation')
    } finally {
      setIsInviting(false)
    }
  }

  const handleRemoveMember = async (memberId: number, memberName: string) => {
    if (!confirm(`Are you sure you want to remove ${memberName} from the team?`)) {
      return
    }

    setIsRemovingMember(memberId)
    setTeamError('')
    setTeamSuccess('')

    try {
      await apiClient.removeTeamMember(memberId)
      setTeamSuccess('Member removed successfully')
      await loadTeamData()
    } catch (error: unknown) {
      setTeamError(error instanceof Error ? error.message : 'Failed to remove member')
    } finally {
      setIsRemovingMember(null)
    }
  }

  const handleAcceptInvitation = async (invitationId: number) => {
    setIsRespondingToInvitation(invitationId)
    setTeamError('')
    setTeamSuccess('')

    try {
      await apiClient.acceptInvitation(invitationId)
      setTeamSuccess('Invitation accepted! Reloading team data...')
      await loadTeamData()
    } catch (error: unknown) {
      setTeamError(error instanceof Error ? error.message : 'Failed to accept invitation')
    } finally {
      setIsRespondingToInvitation(null)
    }
  }

  const handleRejectInvitation = async (invitationId: number) => {
    setIsRespondingToInvitation(invitationId)
    setTeamError('')
    setTeamSuccess('')

    try {
      await apiClient.rejectInvitation(invitationId)
      setTeamSuccess('Invitation rejected')
      await loadTeamData()
    } catch (error: unknown) {
      setTeamError(error instanceof Error ? error.message : 'Failed to reject invitation')
    } finally {
      setIsRespondingToInvitation(null)
    }
  }

  return (
    <div className="min-h-screen bg-dark-bg-primary py-8">
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-dark-text-primary">Account Settings</h1>
              <p className="text-dark-text-secondary mt-1">Manage your security and authentication preferences</p>
            </div>
            <Button onClick={() => navigate('/app')} variant="secondary">
              <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              Back
            </Button>
          </div>
        </div>

        <div className="space-y-6">
          {/* Password Change Section */}
          <Card className="shadow-md">
            <div className="p-6 sm:p-8 flex items-start gap-4">
              <div className="flex-shrink-0 w-10 h-10 bg-primary-500/10 rounded-lg flex items-center justify-center">
                <svg className="w-6 h-6 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
              </div>
              <div className="flex-1">
                <h2 className="text-xl font-semibold text-dark-text-primary mb-1">Change Password</h2>
                <p className="text-sm text-dark-text-secondary mb-6">Update your password to keep your account secure</p>

                {passwordSuccess && (
                  <div className="mb-4 p-4 bg-success-500/10 border-l-4 border-success-400 rounded-r-lg">
                    <div className="flex items-center">
                      <svg className="w-5 h-5 text-success-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                      </svg>
                      <span className="text-success-300 font-medium">{passwordSuccess}</span>
                    </div>
                  </div>
                )}

                <form onSubmit={handlePasswordChange} className="space-y-4">
                  <TextInput
                    label="Current Password"
                    type="password"
                    value={currentPassword}
                    onChange={(e) => setCurrentPassword(e.target.value)}
                    required
                    autoComplete="current-password"
                  />

                  <TextInput
                    label="New Password"
                    type="password"
                    value={newPassword}
                    onChange={(e) => setNewPassword(e.target.value)}
                    required
                    autoComplete="new-password"
                    helpText="Must be at least 8 characters with a letter and number"
                  />

                  <TextInput
                    label="Confirm New Password"
                    type="password"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    required
                    autoComplete="new-password"
                  />

                  {passwordError && <FormError message={passwordError} />}

                  <Button
                    type="submit"
                    disabled={isChangingPassword}
                    className="w-full sm:w-auto"
                  >
                    {isChangingPassword ? 'Changing Password...' : 'Change Password'}
                  </Button>
                </form>
              </div>
            </div>
          </Card>

          {/* Two-Factor Authentication Section */}
          <Card className="shadow-md">
            <div className="p-6 sm:p-8 flex items-start gap-4">
              <div className="flex-shrink-0 w-10 h-10 bg-purple-500/10 rounded-lg flex items-center justify-center">
                <svg className="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
              </div>
              <div className="flex-1">
                <h2 className="text-xl font-semibold text-dark-text-primary mb-1">Two-Factor Authentication</h2>
                <p className="text-sm text-dark-text-secondary mb-6">Add an extra layer of security to your account</p>

                {/* Status Badge */}
                <div className="mb-6 p-4 bg-dark-bg-primary border border-dark-border-subtle rounded-lg flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`w-3 h-3 rounded-full ${twoFAEnabled ? 'bg-success-500' : 'bg-dark-text-tertiary'}`}></div>
                    <div>
                      <p className="font-medium text-dark-text-primary">Status</p>
                      <p className="text-sm text-dark-text-secondary">{twoFAEnabled ? 'Active' : 'Not configured'}</p>
                    </div>
                  </div>
                  <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                    twoFAEnabled
                      ? 'bg-success-500/10 text-success-400'
                      : 'bg-dark-bg-secondary text-dark-text-tertiary'
                  }`}>
                    {twoFAEnabled ? '✓ Enabled' : 'Disabled'}
                  </span>
                </div>

                {twoFASuccess && (
                  <div className="mb-4 p-4 bg-success-500/10 border-l-4 border-success-400 rounded-r-lg">
                    <div className="flex items-center">
                      <svg className="w-5 h-5 text-success-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                      </svg>
                      <span className="text-success-300 font-medium">{twoFASuccess}</span>
                    </div>
                  </div>
                )}

                {twoFAError && <FormError message={twoFAError} className="mb-4" />}

                {/* Enable 2FA Flow */}
                {!twoFAEnabled && !qrCodeURL && (
                  <div>
                    <div className="bg-primary-500/10 border border-primary-500/30 rounded-lg p-4 mb-4">
                      <div className="flex gap-3">
                        <svg className="w-5 h-5 text-primary-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                        <div className="text-sm text-dark-text-secondary">
                          <p className="font-medium mb-1 text-dark-text-primary">How it works</p>
                          <p>Two-factor authentication adds an extra security layer. You'll need your password and a verification code from your phone to sign in.</p>
                        </div>
                      </div>
                    </div>
                    <Button onClick={handleSetup2FA} disabled={isSettingUp2FA}>
                      {isSettingUp2FA ? 'Setting up...' : 'Enable 2FA'}
                    </Button>
                  </div>
                )}

                {/* QR Code Display */}
                {qrCodeURL && !twoFAEnabled && (
                  <div className="space-y-4">
                    <div className="bg-dark-bg-primary border-2 border-dark-border-subtle rounded-xl p-6">
                      <div className="flex items-center gap-2 mb-4">
                        <div className="w-8 h-8 bg-purple-500/10 rounded-full flex items-center justify-center text-purple-400 font-bold">1</div>
                        <h3 className="font-semibold text-dark-text-primary">Scan QR Code</h3>
                      </div>
                      <p className="text-sm text-dark-text-secondary mb-4">
                        Open your authenticator app (Google Authenticator, Authy, 1Password, etc.) and scan this code
                      </p>
                      <div className="flex flex-col items-center gap-4">
                        <div className="bg-white p-4 rounded-lg border-2 border-dark-border-subtle shadow-sm">
                          <img src={qrCodeURL} alt="2FA QR Code" className="w-48 h-48" />
                        </div>

                        <div className="w-full bg-dark-bg-secondary p-4 rounded-lg border border-dark-border-subtle">
                          <p className="text-xs font-medium text-dark-text-secondary mb-2">Manual Entry Key:</p>
                          <div className="flex items-center gap-2">
                            <code className="flex-1 text-sm font-mono bg-dark-bg-primary text-dark-text-primary px-3 py-2 rounded border border-dark-border-subtle break-all">
                              {twoFASecret}
                            </code>
                            <Button size="sm" variant="secondary" onClick={copySecret}>
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                            </Button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <form onSubmit={handleEnable2FA} className="bg-dark-bg-primary border-2 border-dark-border-subtle rounded-xl p-6">
                      <div className="flex items-center gap-2 mb-4">
                        <div className="w-8 h-8 bg-purple-500/10 rounded-full flex items-center justify-center text-purple-400 font-bold">2</div>
                        <h3 className="font-semibold text-dark-text-primary">Enter Verification Code</h3>
                      </div>
                      <p className="text-sm text-dark-text-secondary mb-4">
                        Enter the 6-digit code shown in your authenticator app
                      </p>
                      <div className="flex gap-3">
                        <input
                          type="text"
                          value={verificationCode}
                          onChange={(e) => setVerificationCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                          placeholder="000000"
                          maxLength={6}
                          pattern="\d{6}"
                          required
                          className="flex-1 text-center text-3xl font-mono tracking-widest px-4 py-3 border-2 border-dark-border-subtle bg-dark-bg-secondary text-dark-text-primary rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 outline-none transition-colors placeholder-dark-text-tertiary"
                        />
                        <Button type="submit" disabled={isEnabling2FA || verificationCode.length !== 6}>
                          {isEnabling2FA ? 'Verifying...' : 'Verify & Enable'}
                        </Button>
                      </div>
                    </form>
                  </div>
                )}

                {/* Backup Codes Display */}
                {showBackupCodes && backupCodes.length > 0 && (
                  <div className="border-2 border-yellow-500/30 bg-yellow-500/10 rounded-xl p-6">
                    <div className="flex items-start gap-3 mb-4">
                      <svg className="w-6 h-6 text-yellow-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                      </svg>
                      <div>
                        <h3 className="font-bold text-yellow-300 mb-1">Save Your Backup Codes</h3>
                        <p className="text-sm text-yellow-400/90">
                          Store these codes in a safe place. You can use them to access your account if you lose your device. Each code can only be used once.
                        </p>
                      </div>
                    </div>

                    <div className="bg-dark-bg-primary p-5 rounded-lg border-2 border-yellow-500/30 mb-4">
                      <div className="grid grid-cols-2 gap-3">
                        {backupCodes.map((code, index) => (
                          <div key={index} className="flex items-center justify-between p-3 bg-dark-bg-secondary rounded-lg border border-dark-border-subtle">
                            <span className="font-mono text-sm font-medium text-dark-text-primary">{code}</span>
                            <button
                              onClick={() => {
                                copyToClipboard(code)
                                setTwoFASuccess(`Code ${index + 1} copied`)
                              }}
                              className="text-primary-400 hover:text-primary-300 text-xs font-medium px-2 py-1 rounded hover:bg-primary-500/10 transition-colors"
                            >
                              Copy
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>

                    <Button onClick={copyAllBackupCodes} variant="secondary" className="w-full">
                      <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      Copy All Codes
                    </Button>
                  </div>
                )}

                {/* Disable 2FA */}
                {twoFAEnabled && !showBackupCodes && (
                  <form onSubmit={handleDisable2FA} className="space-y-4">
                    <div className="bg-danger-500/10 border-l-4 border-danger-400 rounded-r-lg p-4">
                      <div className="flex items-start gap-3">
                        <svg className="w-5 h-5 text-danger-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                        </svg>
                        <div className="flex-1">
                          <h3 className="font-semibold text-danger-300 mb-1">Disable Two-Factor Authentication</h3>
                          <p className="text-sm text-danger-400/90 mb-4">
                            This will make your account less secure. Enter your password to confirm.
                          </p>

                          <TextInput
                            label="Password"
                            type="password"
                            value={disablePassword}
                            onChange={(e) => setDisablePassword(e.target.value)}
                            required
                            autoComplete="current-password"
                          />

                          <Button
                            type="submit"
                            variant="danger"
                            disabled={isDisabling2FA}
                            className="w-full mt-4"
                          >
                            {isDisabling2FA ? 'Disabling...' : 'Disable 2FA'}
                          </Button>
                        </div>
                      </div>
                    </div>
                  </form>
                )}
              </div>
            </div>
          </Card>

          {/* Cloudinary Section */}
          <Card className="shadow-md">
            <div className="p-6 sm:p-8 flex items-start gap-4">
              <div className="flex-shrink-0 w-10 h-10 bg-orange-500/10 rounded-lg flex items-center justify-center">
                <svg className="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
              </div>
              <div className="flex-1">
                <h2 className="text-xl font-semibold text-dark-text-primary mb-1">Cloudinary Storage</h2>
                <p className="text-sm text-dark-text-secondary mb-6">
                  Connect your Cloudinary account to upload images, videos, and PDFs to tasks
                </p>

                {cloudinarySuccess && (
                  <div className="mb-4 p-4 bg-success-500/10 border-l-4 border-success-400 rounded-r-lg">
                    <div className="flex items-center">
                      <svg className="w-5 h-5 text-success-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                      </svg>
                      <span className="text-success-300 font-medium">{cloudinarySuccess}</span>
                    </div>
                  </div>
                )}

                {cloudinaryError && <FormError message={cloudinaryError} className="mb-4" />}

                {hasCloudinaryCredentials && (
                  <div className="mb-6 p-4 bg-dark-bg-primary border border-dark-border-subtle rounded-lg space-y-3">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className={`w-3 h-3 rounded-full ${
                          cloudinaryStatus === 'connected' ? 'bg-success-500' :
                          cloudinaryStatus === 'error' ? 'bg-danger-500' :
                          cloudinaryStatus === 'suspended' ? 'bg-yellow-500' :
                          'bg-dark-text-tertiary'
                        }`}></div>
                        <div>
                          <p className="font-medium text-dark-text-primary">
                            {cloudinaryStatus === 'connected' ? 'Connected' :
                             cloudinaryStatus === 'error' ? 'Connection Error' :
                             cloudinaryStatus === 'suspended' ? 'Suspended' :
                             'Unknown'}
                          </p>
                          <p className="text-sm text-dark-text-secondary">
                            Cloud: {cloudName} &middot; Max file size: {cloudMaxSize}MB
                            {cloudinaryLastChecked && (
                              <> &middot; Checked: {new Date(cloudinaryLastChecked).toLocaleString()}</>
                            )}
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <Button
                          size="sm"
                          variant="secondary"
                          onClick={handleTestCloudinary}
                          disabled={isTestingCloudinary}
                        >
                          {isTestingCloudinary ? 'Testing...' : 'Test Connection'}
                        </Button>
                        <Button
                          size="sm"
                          variant="danger"
                          onClick={handleDeleteCloudinary}
                          disabled={isDeletingCloudinary}
                        >
                          {isDeletingCloudinary ? 'Removing...' : 'Remove'}
                        </Button>
                      </div>
                    </div>
                    {cloudinaryLastError && cloudinaryStatus !== 'connected' && (
                      <div className="text-sm text-danger-400 bg-danger-500/10 px-3 py-2 rounded">
                        {cloudinaryLastError}
                        {cloudinaryConsecutiveFailures >= 5 && (
                          <span className="block mt-1 text-yellow-400">
                            Auto-checks suspended after {cloudinaryConsecutiveFailures} consecutive failures. Use "Test Connection" to retry.
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                )}

                <form onSubmit={handleSaveCloudinary} className="space-y-4">
                  <TextInput
                    label="Cloud Name"
                    value={cloudName}
                    onChange={(e) => setCloudName(e.target.value)}
                    placeholder="e.g. drfaxtpug"
                    helpText="Found in Cloudinary Console → Settings → API Keys. It's the short identifier after the @ in your CLOUDINARY_URL."
                    required
                  />

                  <TextInput
                    label="API Key"
                    value={cloudAPIKey}
                    onChange={(e) => setCloudAPIKey(e.target.value)}
                    placeholder="e.g. 587593568128219"
                    helpText="The numeric key from your Cloudinary API Keys page (console.cloudinary.com → Settings → API Keys)."
                    required
                  />

                  <TextInput
                    label={hasCloudinaryCredentials ? 'API Secret (enter to update)' : 'API Secret'}
                    type="password"
                    value={cloudAPISecret}
                    onChange={(e) => setCloudAPISecret(e.target.value)}
                    placeholder={hasCloudinaryCredentials ? '••••••••••••' : 'Enter your API secret'}
                    helpText="Click the eye icon next to your API key on the Cloudinary API Keys page to reveal it."
                    required={!hasCloudinaryCredentials}
                  />

                  <div>
                    <label className="block text-sm font-medium text-dark-text-primary mb-2">
                      Max File Size (MB)
                    </label>
                    <select
                      value={cloudMaxSize}
                      onChange={(e) => setCloudMaxSize(parseInt(e.target.value))}
                      className="w-full px-3 py-2 border border-dark-border-subtle bg-dark-bg-secondary text-dark-text-primary rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 outline-none transition-colors"
                    >
                      <option value="5">5 MB</option>
                      <option value="10">10 MB</option>
                      <option value="25">25 MB</option>
                      <option value="50">50 MB</option>
                      <option value="100">100 MB</option>
                    </select>
                  </div>

                  <Button type="submit" disabled={isSavingCloudinary}>
                    {isSavingCloudinary ? 'Saving...' : hasCloudinaryCredentials ? 'Update Credentials' : 'Save Credentials'}
                  </Button>
                </form>

                <div className="mt-6 bg-orange-500/10 border border-orange-500/30 rounded-lg p-4">
                  <div className="flex gap-3">
                    <svg className="w-5 h-5 text-orange-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                    </svg>
                    <div className="text-sm text-dark-text-secondary">
                      <p className="font-medium mb-1 text-dark-text-primary">How file storage works</p>
                      <p className="mb-2">Files are uploaded directly to your Cloudinary account. In team projects, each member uses their own Cloudinary quota. Storage usage is tracked per user per project.</p>
                      <p>Find your credentials at <a href="https://console.cloudinary.com/settings/api-keys" target="_blank" rel="noopener noreferrer" className="text-orange-400 underline hover:text-orange-300">Cloudinary Console &rarr; Settings &rarr; API Keys</a>. Your cloud name, API key, and secret are all on that page.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </Card>

          {/* API Keys Section */}
          <Card className="shadow-md" id="api-keys">
            <div className="p-6 sm:p-8 flex items-start gap-4">
              <div className="flex-shrink-0 w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center">
                <svg className="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
              </div>
              <div className="flex-1">
                <h2 className="text-xl font-semibold text-dark-text-primary mb-1">API Keys</h2>
                <p className="text-sm text-dark-text-secondary mb-6">Create and manage API keys for programmatic access</p>

                {apiKeySuccess && (
                  <div className="mb-4 p-4 bg-success-500/10 border-l-4 border-success-400 rounded-r-lg">
                    <div className="flex items-center">
                      <svg className="w-5 h-5 text-success-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                      </svg>
                      <span className="text-success-300 font-medium">{apiKeySuccess}</span>
                    </div>
                  </div>
                )}

                {apiKeyError && <FormError message={apiKeyError} className="mb-4" />}

                {/* Newly Created Key Display */}
                {createdKey && (
                  <div className="mb-6 border-2 border-yellow-500/30 bg-yellow-500/10 rounded-xl p-6">
                    <div className="flex items-start gap-3 mb-4">
                      <svg className="w-6 h-6 text-yellow-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                      </svg>
                      <div>
                        <h3 className="font-bold text-yellow-300 mb-1">Save Your API Key</h3>
                        <p className="text-sm text-yellow-400/90">
                          This is the only time you'll see the full key. Copy it now and store it securely.
                        </p>
                      </div>
                    </div>

                    <div className="bg-dark-bg-primary p-5 rounded-lg border-2 border-yellow-500/30 mb-4">
                      <p className="text-xs font-medium text-dark-text-secondary mb-2">Key Name: {createdKey.name}</p>
                      <div className="flex items-center gap-2">
                        <code className="flex-1 text-sm font-mono bg-dark-bg-secondary text-dark-text-primary px-3 py-2 rounded border border-dark-border-subtle break-all">
                          {createdKey.key}
                        </code>
                        <Button size="sm" variant="secondary" onClick={() => copyAPIKey(createdKey.key)}>
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                          </svg>
                        </Button>
                      </div>
                    </div>

                    <Button onClick={() => setCreatedKey(null)} variant="secondary" className="w-full">
                      I've saved my key
                    </Button>
                  </div>
                )}

                {/* Create New Key Form */}
                <form onSubmit={handleCreateAPIKey} className="mb-6 space-y-4">
                  <TextInput
                    label="Key Name"
                    value={newKeyName}
                    onChange={(e) => setNewKeyName(e.target.value)}
                    placeholder="e.g., CI/CD Pipeline, Mobile App"
                    required
                  />

                  <div>
                    <label className="block text-sm font-medium text-dark-text-primary mb-2">
                      Expiration
                    </label>
                    <select
                      value={newKeyExpires || ''}
                      onChange={(e) => setNewKeyExpires(e.target.value ? parseInt(e.target.value) : undefined)}
                      className="w-full px-3 py-2 border border-dark-border-subtle bg-dark-bg-secondary text-dark-text-primary rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 outline-none transition-colors"
                    >
                      <option value="30">30 days</option>
                      <option value="90">90 days</option>
                      <option value="180">180 days</option>
                      <option value="365">1 year</option>
                      <option value="">Never expires</option>
                    </select>
                  </div>

                  <Button type="submit" disabled={isCreatingKey}>
                    {isCreatingKey ? 'Creating...' : 'Create API Key'}
                  </Button>
                </form>

                {/* Existing Keys List */}
                <div>
                  <h3 className="text-sm font-semibold text-dark-text-primary mb-3">Active API Keys</h3>
                  {apiKeys.length === 0 ? (
                    <div className="text-center py-8 text-dark-text-tertiary">
                      <svg className="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                      </svg>
                      <p className="text-sm">No API keys created yet</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {apiKeys.map((key) => (
                        <div key={key.id} className="p-4 bg-dark-bg-secondary border border-dark-border-subtle rounded-lg">
                          <div className="flex items-center justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-3">
                                <h4 className="font-medium text-dark-text-primary">{key.name}</h4>
                                <code className="text-xs font-mono bg-dark-bg-primary text-dark-text-secondary px-2 py-1 rounded border border-dark-border-subtle">
                                  {key.key_prefix}...
                                </code>
                              </div>
                              <div className="mt-1 flex items-center gap-4 text-xs text-dark-text-tertiary">
                                <span>Created: {formatDate(key.created_at)}</span>
                                {key.last_used_at && <span>Last used: {formatDate(key.last_used_at)}</span>}
                                {key.expires_at && <span>Expires: {formatDate(key.expires_at)}</span>}
                              </div>
                            </div>
                            <Button
                              size="sm"
                              variant="danger"
                              onClick={() => handleDeleteAPIKey(key.id, key.name)}
                              disabled={isDeletingKey === key.id}
                            >
                              {isDeletingKey === key.id ? 'Deleting...' : 'Delete'}
                            </Button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="mt-6 bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <div className="flex gap-3">
                    <svg className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                    </svg>
                    <div className="text-sm text-dark-text-secondary">
                      <p className="font-medium mb-1 text-dark-text-primary">Using API keys</p>
                      <p className="mb-2">Include your API key in the Authorization header:</p>
                      <code className="block bg-dark-bg-secondary text-dark-text-primary px-3 py-2 rounded border border-dark-border-subtle font-mono text-xs">
                        Authorization: ApiKey YOUR_API_KEY
                      </code>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </Card>

          {/* API & Integrations Section */}
          <Card className="shadow-md">
            <div className="p-6 sm:p-8 flex items-start gap-4">
              <div className="flex-shrink-0 w-10 h-10 bg-cyan-500/10 rounded-lg flex items-center justify-center">
                <svg className="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
              </div>
              <div className="flex-1">
                <h2 className="text-xl font-semibold text-dark-text-primary mb-1">API & Integrations</h2>
                <p className="text-sm text-dark-text-secondary mb-6">
                  Connect to TaskAI via REST API or MCP (Model Context Protocol) for AI assistants
                </p>

                {copiedSnippet && (
                  <div className="mb-4 p-3 bg-success-500/10 border-l-4 border-success-400 rounded-r-lg">
                    <div className="flex items-center">
                      <svg className="w-4 h-4 text-success-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                      </svg>
                      <span className="text-success-300 text-sm font-medium">Copied to clipboard</span>
                    </div>
                  </div>
                )}

                {/* OpenAPI Section */}
                <div className="mb-6">
                  <h3 className="text-sm font-semibold text-dark-text-primary mb-3">OpenAPI / REST</h3>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between p-3 bg-dark-bg-primary border border-dark-border-subtle rounded-lg">
                      <div>
                        <p className="text-xs font-medium text-dark-text-tertiary">OpenAPI Spec</p>
                        <code className="text-sm text-dark-text-primary font-mono">{window.location.origin}/api/openapi</code>
                      </div>
                      <div className="flex items-center gap-1.5">
                        <button
                          onClick={() => { copyToClipboard(`${window.location.origin}/api/openapi`); setCopiedSnippet('spec'); setTimeout(() => setCopiedSnippet(null), 2000) }}
                          className="p-1.5 text-dark-text-tertiary hover:text-dark-text-primary hover:bg-dark-bg-tertiary rounded transition-colors"
                          title="Copy URL"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                          </svg>
                        </button>
                        <a
                          href={`${window.location.origin}/api/openapi`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="p-1.5 text-dark-text-tertiary hover:text-dark-text-primary hover:bg-dark-bg-tertiary rounded transition-colors"
                          title="Open in new tab"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                          </svg>
                        </a>
                      </div>
                    </div>
                    <div className="flex items-center justify-between p-3 bg-dark-bg-primary border border-dark-border-subtle rounded-lg">
                      <div>
                        <p className="text-xs font-medium text-dark-text-tertiary">API Docs</p>
                        <code className="text-sm text-dark-text-primary font-mono">{window.location.origin}/api/docs</code>
                      </div>
                      <div className="flex items-center gap-1.5">
                        <button
                          onClick={() => { copyToClipboard(`${window.location.origin}/api/docs`); setCopiedSnippet('docs'); setTimeout(() => setCopiedSnippet(null), 2000) }}
                          className="p-1.5 text-dark-text-tertiary hover:text-dark-text-primary hover:bg-dark-bg-tertiary rounded transition-colors"
                          title="Copy URL"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                          </svg>
                        </button>
                        <a
                          href={`${window.location.origin}/api/docs`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="p-1.5 text-dark-text-tertiary hover:text-dark-text-primary hover:bg-dark-bg-tertiary rounded transition-colors"
                          title="Open in new tab"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                          </svg>
                        </a>
                      </div>
                    </div>
                  </div>

                  {/* curl example */}
                  <div className="mt-3">
                    <div className="flex items-center justify-between mb-1">
                      <p className="text-xs font-medium text-dark-text-tertiary">Example: curl</p>
                      <button
                        onClick={() => {
                          copyToClipboard(`curl -H "Authorization: ApiKey YOUR_API_KEY" ${window.location.origin}/api/projects`)
                          setCopiedSnippet('curl')
                          setTimeout(() => setCopiedSnippet(null), 2000)
                        }}
                        className="text-xs text-dark-text-tertiary hover:text-dark-text-primary transition-colors"
                      >
                        {copiedSnippet === 'curl' ? 'Copied!' : 'Copy'}
                      </button>
                    </div>
                    <pre className="bg-dark-bg-primary border border-dark-border-subtle rounded-lg p-3 overflow-x-auto">
                      <code className="text-xs font-mono text-dark-text-secondary">
{`curl -H "Authorization: ApiKey YOUR_API_KEY" \\
  ${window.location.origin}/api/projects`}
                      </code>
                    </pre>
                  </div>

                  {/* Python example */}
                  <div className="mt-3">
                    <div className="flex items-center justify-between mb-1">
                      <p className="text-xs font-medium text-dark-text-tertiary">Example: Python</p>
                      <button
                        onClick={() => {
                          copyToClipboard(`import requests\n\nheaders = {"Authorization": "ApiKey YOUR_API_KEY"}\nresponse = requests.get("${window.location.origin}/api/projects", headers=headers)\nprint(response.json())`)
                          setCopiedSnippet('python')
                          setTimeout(() => setCopiedSnippet(null), 2000)
                        }}
                        className="text-xs text-dark-text-tertiary hover:text-dark-text-primary transition-colors"
                      >
                        {copiedSnippet === 'python' ? 'Copied!' : 'Copy'}
                      </button>
                    </div>
                    <pre className="bg-dark-bg-primary border border-dark-border-subtle rounded-lg p-3 overflow-x-auto">
                      <code className="text-xs font-mono text-dark-text-secondary">
{`import requests

headers = {"Authorization": "ApiKey YOUR_API_KEY"}
response = requests.get(
    "${window.location.origin}/api/projects",
    headers=headers
)
print(response.json())`}
                      </code>
                    </pre>
                  </div>
                </div>

                {/* MCP Section */}
                <div className="mb-4">
                  <h3 className="text-sm font-semibold text-dark-text-primary mb-3">MCP (Model Context Protocol)</h3>
                  <p className="text-sm text-dark-text-secondary mb-3">
                    Connect AI assistants like Claude to TaskAI using the MCP protocol.
                  </p>

                  <div className="flex items-center justify-between p-3 bg-dark-bg-primary border border-dark-border-subtle rounded-lg mb-3">
                    <div>
                      <p className="text-xs font-medium text-dark-text-tertiary">MCP Endpoint</p>
                      <code className="text-sm text-dark-text-primary font-mono">
                        {(() => {
                          const hostname = window.location.hostname
                          if (hostname === 'taskai.cc') return 'https://mcp.taskai.cc/mcp'
                          if (hostname === 'staging.taskai.cc') return 'https://mcp.staging.taskai.cc/mcp'
                          return `${window.location.origin}/mcp`
                        })()}
                      </code>
                    </div>
                    <button
                      onClick={() => {
                        const hostname = window.location.hostname
                        let mcpUrl = `${window.location.origin}/mcp`
                        if (hostname === 'taskai.cc') mcpUrl = 'https://mcp.taskai.cc/mcp'
                        if (hostname === 'staging.taskai.cc') mcpUrl = 'https://mcp.staging.taskai.cc/mcp'
                        copyToClipboard(mcpUrl)
                        setCopiedSnippet('mcp-url')
                        setTimeout(() => setCopiedSnippet(null), 2000)
                      }}
                      className="p-1.5 text-dark-text-tertiary hover:text-dark-text-primary hover:bg-dark-bg-tertiary rounded transition-colors"
                      title="Copy URL"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </div>

                  {/* Available tools */}
                  <div className="mb-3">
                    <p className="text-xs font-medium text-dark-text-tertiary mb-2">Available Tools (8)</p>
                    <div className="flex flex-wrap gap-1.5">
                      {['get_me', 'list_projects', 'get_project', 'list_tasks', 'create_task', 'update_task', 'list_comments', 'add_comment'].map(tool => (
                        <span key={tool} className="px-2 py-0.5 text-xs font-mono bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 rounded">
                          {tool}
                        </span>
                      ))}
                    </div>
                  </div>

                  {/* Claude Code config */}
                  <div className="mt-3">
                    <div className="flex items-center justify-between mb-1">
                      <p className="text-xs font-medium text-dark-text-tertiary">Claude Code MCP Config</p>
                      <button
                        onClick={() => {
                          const hostname = window.location.hostname
                          let mcpUrl = `${window.location.origin}/mcp`
                          if (hostname === 'taskai.cc') mcpUrl = 'https://mcp.taskai.cc/mcp'
                          if (hostname === 'staging.taskai.cc') mcpUrl = 'https://mcp.staging.taskai.cc/mcp'
                          copyToClipboard(JSON.stringify({
                            mcpServers: {
                              taskai: {
                                type: "streamable-http",
                                url: mcpUrl,
                                headers: { "X-API-Key": "YOUR_API_KEY" }
                              }
                            }
                          }, null, 2))
                          setCopiedSnippet('mcp-config')
                          setTimeout(() => setCopiedSnippet(null), 2000)
                        }}
                        className="text-xs text-dark-text-tertiary hover:text-dark-text-primary transition-colors"
                      >
                        {copiedSnippet === 'mcp-config' ? 'Copied!' : 'Copy'}
                      </button>
                    </div>
                    <pre className="bg-dark-bg-primary border border-dark-border-subtle rounded-lg p-3 overflow-x-auto">
                      <code className="text-xs font-mono text-dark-text-secondary">
{JSON.stringify({
  mcpServers: {
    taskai: {
      type: "streamable-http",
      url: (() => {
        const hostname = window.location.hostname
        if (hostname === 'taskai.cc') return 'https://mcp.taskai.cc/mcp'
        if (hostname === 'staging.taskai.cc') return 'https://mcp.staging.taskai.cc/mcp'
        return `${window.location.origin}/mcp`
      })(),
      headers: { "X-API-Key": "YOUR_API_KEY" }
    }
  }
}, null, 2)}
                      </code>
                    </pre>
                  </div>
                </div>

                <div className="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4">
                  <div className="flex gap-3">
                    <svg className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                    </svg>
                    <div className="text-sm text-dark-text-secondary">
                      <p className="font-medium mb-1 text-dark-text-primary">Authentication</p>
                      <p className="mb-2">
                        All API requests require an API key. Create one in the{' '}
                        <a href="#api-keys" className="text-cyan-400 underline hover:text-cyan-300">API Keys section above</a>.
                      </p>
                      <p>
                        REST API: <code className="bg-dark-bg-primary px-1.5 py-0.5 rounded text-xs font-mono text-dark-text-primary">Authorization: ApiKey YOUR_API_KEY</code>
                        <br />
                        MCP: <code className="bg-dark-bg-primary px-1.5 py-0.5 rounded text-xs font-mono text-dark-text-primary">X-API-Key: YOUR_API_KEY</code>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </Card>

          {/* Invites Section */}
          <Card className="shadow-md">
            <div className="p-6 sm:p-8 flex items-start gap-4">
              <div className="flex-shrink-0 w-10 h-10 bg-indigo-500/10 rounded-lg flex items-center justify-center">
                <svg className="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
              </div>
              <div className="flex-1">
                <h2 className="text-xl font-semibold text-dark-text-primary mb-1">Invite Friends</h2>
                <p className="text-sm text-dark-text-secondary mb-6">
                  TaskAI is invite-only. Share invite links with friends to let them join.
                </p>

                {inviteSuccess && (
                  <div className="mb-4 p-4 bg-success-500/10 border-l-4 border-success-400 rounded-r-lg">
                    <div className="flex items-center">
                      <svg className="w-5 h-5 text-success-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                      </svg>
                      <span className="text-success-300 font-medium">{inviteSuccess}</span>
                    </div>
                  </div>
                )}

                {inviteError && <FormError message={inviteError} className="mb-4" />}

                {/* Invite count status */}
                <div className="mb-6 p-4 bg-dark-bg-primary border border-dark-border-subtle rounded-lg space-y-3">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className={`w-3 h-3 rounded-full ${(isUserAdmin || myInviteCount > 0) ? 'bg-success-500' : 'bg-dark-text-tertiary'}`}></div>
                      <div>
                        <p className="font-medium text-dark-text-primary">Invites Available</p>
                        <p className="text-sm text-dark-text-secondary">
                          {isUserAdmin ? 'Unlimited (admin)' : `${myInviteCount} remaining`}
                        </p>
                      </div>
                    </div>
                    <Button
                      onClick={handleCreateInviteCode}
                      disabled={isCreatingInvite || (!isUserAdmin && myInviteCount <= 0)}
                      size="sm"
                    >
                      {isCreatingInvite ? 'Creating...' : 'Create Invite'}
                    </Button>
                  </div>
                  <div>
                    <input
                      type="email"
                      value={inviteRecipientEmail}
                      onChange={(e) => setInviteRecipientEmail(e.target.value)}
                      placeholder="Recipient email (optional — sends invite automatically)"
                      className="w-full px-3 py-2 text-sm bg-dark-bg-secondary border border-dark-border-subtle rounded-lg text-dark-text-primary placeholder-dark-text-tertiary focus:outline-none focus:border-primary-500"
                    />
                  </div>
                </div>

                {/* Newly created invite link */}
                {newInviteCode && (
                  <div className="mb-6 border-2 border-indigo-500/30 bg-indigo-500/10 rounded-xl p-6">
                    <div className="flex items-start gap-3 mb-4">
                      <svg className="w-6 h-6 text-indigo-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                      </svg>
                      <div>
                        <h3 className="font-bold text-indigo-300 mb-1">Share This Link</h3>
                        <p className="text-sm text-indigo-400/90">
                          Send this link to your friend. It expires in 7 days.
                        </p>
                      </div>
                    </div>

                    <div className="bg-dark-bg-primary p-4 rounded-lg border-2 border-indigo-500/30 mb-4">
                      <div className="flex items-center gap-2">
                        <code className="flex-1 text-sm font-mono bg-dark-bg-secondary text-dark-text-primary px-3 py-2 rounded border border-dark-border-subtle break-all">
                          {window.location.origin}/signup?code={newInviteCode}
                        </code>
                        <Button size="sm" variant="secondary" onClick={() => copyInviteLink(newInviteCode)}>
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                          </svg>
                        </Button>
                      </div>
                    </div>

                    <Button onClick={() => setNewInviteCode('')} variant="secondary" className="w-full">
                      Done
                    </Button>
                  </div>
                )}

                {/* Existing invites list */}
                <div>
                  <h3 className="text-sm font-semibold text-dark-text-primary mb-3">Your Invites</h3>
                  {myInvites.length === 0 ? (
                    <div className="text-center py-8 text-dark-text-tertiary">
                      <svg className="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                      <p className="text-sm">No invites created yet</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {myInvites.map((inv: Invite) => (
                        <div key={inv.id} className="p-4 bg-dark-bg-secondary border border-dark-border-subtle rounded-lg">
                          <div className="flex items-center justify-between">
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2">
                                <code className="text-xs font-mono bg-dark-bg-primary text-dark-text-secondary px-2 py-1 rounded border border-dark-border-subtle">
                                  {inv.code.substring(0, 12)}...
                                </code>
                                {inv.used_at ? (
                                  <span className="px-2 py-0.5 text-xs font-medium bg-success-500/10 text-success-400 rounded">
                                    Used
                                  </span>
                                ) : (
                                  <span className="px-2 py-0.5 text-xs font-medium bg-primary-500/10 text-primary-400 rounded">
                                    Available
                                  </span>
                                )}
                              </div>
                              <div className="mt-1 flex items-center gap-4 text-xs text-dark-text-tertiary">
                                <span>Created: {formatDate(inv.created_at)}</span>
                                {inv.used_at && inv.invitee_name && (
                                  <span>Used by: {inv.invitee_name}</span>
                                )}
                                {inv.expires_at && !inv.used_at && (
                                  <span>Expires: {formatDate(inv.expires_at)}</span>
                                )}
                              </div>
                            </div>
                            {!inv.used_at && (
                              <Button
                                size="sm"
                                variant="secondary"
                                onClick={() => copyInviteLink(inv.code)}
                              >
                                Copy Link
                              </Button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="mt-6 bg-indigo-500/10 border border-indigo-500/30 rounded-lg p-4">
                  <div className="flex gap-3">
                    <svg className="w-5 h-5 text-indigo-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                    </svg>
                    <div className="text-sm text-dark-text-secondary">
                      <p className="font-medium mb-1 text-dark-text-primary">About invites</p>
                      <p>Each invite link can be used once and expires after 7 days. You start with 3 invites. Share them wisely!</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </Card>

          {/* Team Management Section */}
          <Card className="shadow-md">
            <div className="p-6 sm:p-8 flex items-start gap-4">
              <div className="flex-shrink-0 w-10 h-10 bg-green-500/10 rounded-lg flex items-center justify-center">
                <svg className="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              </div>
              <div className="flex-1">
                <h2 className="text-xl font-semibold text-dark-text-primary mb-1">Team Management</h2>
                <p className="text-sm text-dark-text-secondary mb-6">Invite team members and manage access to your projects</p>

                {teamSuccess && (
                  <div className="mb-4 p-4 bg-success-500/10 border-l-4 border-success-400 rounded-r-lg">
                    <div className="flex items-center">
                      <svg className="w-5 h-5 text-success-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                      </svg>
                      <span className="text-success-300 font-medium">{teamSuccess}</span>
                    </div>
                  </div>
                )}

                {teamError && <FormError message={teamError} className="mb-4" />}

                {/* Team Info */}
                {team && (
                  <div className="mb-6 p-4 bg-dark-bg-secondary border border-dark-border-subtle rounded-lg">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-dark-text-secondary">Your Team</p>
                        <p className="text-lg font-semibold text-dark-text-primary">{team.name}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-sm text-dark-text-secondary">Members</p>
                        <p className="text-lg font-semibold text-dark-text-primary">{teamMembers.length}</p>
                      </div>
                    </div>
                  </div>
                )}

                {/* Pending Invitations */}
                {invitations.length > 0 && (
                  <div className="mb-6">
                    <h3 className="text-sm font-semibold text-dark-text-primary mb-3">Pending Invitations</h3>
                    <div className="space-y-2">
                      {invitations.map((invitation: TeamInvitation) => (
                        <div key={invitation.id} className="p-4 bg-primary-500/10 border border-primary-500/30 rounded-lg">
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="font-medium text-dark-text-primary">
                                Invitation to join {invitation.team_name}
                              </p>
                              {invitation.inviter_name && (
                                <p className="text-sm text-dark-text-secondary">
                                  From: {invitation.inviter_name}
                                </p>
                              )}
                            </div>
                            <div className="flex gap-2">
                              <Button
                                size="sm"
                                onClick={() => handleAcceptInvitation(invitation.id)}
                                disabled={isRespondingToInvitation === invitation.id}
                              >
                                {isRespondingToInvitation === invitation.id ? 'Accepting...' : 'Accept'}
                              </Button>
                              <Button
                                size="sm"
                                variant="secondary"
                                onClick={() => handleRejectInvitation(invitation.id)}
                                disabled={isRespondingToInvitation === invitation.id}
                              >
                                Decline
                              </Button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Invite Member Form */}
                <form onSubmit={handleInviteMember} className="mb-6">
                  <div className="flex gap-3 items-end">
                    <div className="flex-1">
                      <TextInput
                        label="Invite Team Member"
                        type="email"
                        value={inviteEmail}
                        onChange={(e) => setInviteEmail(e.target.value)}
                        placeholder="email@example.com"
                        required
                      />
                    </div>
                    <Button type="submit" disabled={isInviting}>
                      {isInviting ? 'Inviting...' : 'Send Invite'}
                    </Button>
                  </div>
                </form>

                {/* Team Members List */}
                <div>
                  <h3 className="text-sm font-semibold text-dark-text-primary mb-3">Team Members</h3>
                  {teamMembers.length === 0 ? (
                    <div className="text-center py-8 text-dark-text-tertiary">
                      <svg className="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                      </svg>
                      <p className="text-sm">No team members yet</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {teamMembers.map((member: TeamMember) => (
                        <div key={member.id} className="p-4 bg-dark-bg-secondary border border-dark-border-subtle rounded-lg">
                          <div className="flex items-center justify-between">
                            <div className="flex-1">
                              <div className="flex items-center gap-3">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2">
                                    <h4 className="font-medium text-dark-text-primary">
                                      {member.user_name || member.email}
                                    </h4>
                                    {member.role === 'owner' && (
                                      <span className="px-2 py-0.5 text-xs font-medium bg-primary-500/10 text-primary-400 rounded">
                                        Owner
                                      </span>
                                    )}
                                    {member.role === 'admin' && (
                                      <span className="px-2 py-0.5 text-xs font-medium bg-purple-500/10 text-purple-400 rounded">
                                        Admin
                                      </span>
                                    )}
                                  </div>
                                  <p className="text-sm text-dark-text-tertiary">{member.email}</p>
                                </div>
                              </div>
                            </div>
                            {member.role !== 'owner' && (
                              <Button
                                size="sm"
                                variant="danger"
                                onClick={() => handleRemoveMember(member.id, member.user_name || member.email)}
                                disabled={isRemovingMember === member.id}
                              >
                                {isRemovingMember === member.id ? 'Removing...' : 'Remove'}
                              </Button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="mt-6 bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <div className="flex gap-3">
                    <svg className="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                    </svg>
                    <div className="text-sm text-dark-text-secondary">
                      <p className="font-medium mb-1 text-dark-text-primary">About team access</p>
                      <p>Team members can view and edit all projects, tasks, sprints, and tags shared with the team. Only the team owner can invite or remove members.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </Card>
        </div>
      </div>
    </div>
  )
}
