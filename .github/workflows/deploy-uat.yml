name: Deploy to UAT

on:
  push:
    branches: [ uat ]
  workflow_dispatch:

env:
  GO_VERSION: "1.24"
  NODE_VERSION: "20"

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

  deploy-uat:
    needs: security-scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version information
        id: version
        run: |
          VERSION=$(cat VERSION 2>/dev/null || echo "dev")
          GIT_COMMIT=${GITHUB_SHA::7}
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "GIT_COMMIT=$GIT_COMMIT" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT

          echo "ðŸ·ï¸  Version: $VERSION"
          echo "ðŸ“ Commit: $GIT_COMMIT"
          echo "ðŸ• Build Time: $BUILD_TIME"

      - name: Deploy to UAT server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.UAT_SSH_PRIVATE_KEY }}
          COMMIT_SHA: ${{ github.sha }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          GIT_COMMIT: ${{ steps.version.outputs.GIT_COMMIT }}
          BUILD_TIME: ${{ steps.version.outputs.BUILD_TIME }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan 92.4.83.28 >> ~/.ssh/known_hosts

          echo "ðŸš€ Deploying TaskAI to UAT..."

          ssh -i ~/.ssh/deploy_key ubuntu@92.4.83.28 << ENDSSH
            set -e
            cd /home/ubuntu/taskai-uat/source
            git fetch origin
            git reset --hard $COMMIT_SHA
            cd ..

            export VERSION='$VERSION'
            export GIT_COMMIT='$GIT_COMMIT'
            export BUILD_TIME='$BUILD_TIME'
            export TASKAI_API_PORT=38888
            export TASKAI_WEB_PORT=33333

            docker compose down || true
            docker compose build --build-arg VERSION="\$VERSION" --build-arg GIT_COMMIT="\$GIT_COMMIT" --build-arg BUILD_TIME="\$BUILD_TIME"
            docker compose up -d
            sleep 15
            docker compose ps
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 10
          curl -f https://uat.taskai.cc/api/health || exit 1
          echo "âœ… UAT deployed successfully"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ UAT Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** 92.4.83.28" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://uat.taskai.cc" >> $GITHUB_STEP_SUMMARY
