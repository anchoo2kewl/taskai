name: Deploy to UAT

on:
  push:
    branches: [ uat ]
  workflow_dispatch:

env:
  GO_VERSION: "1.24"
  NODE_VERSION: "20"

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

  deploy-uat:
    needs: security-scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version information
        id: version
        run: |
          VERSION=$(cat VERSION 2>/dev/null || echo "dev")
          GIT_COMMIT=${GITHUB_SHA::7}
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "GIT_COMMIT=$GIT_COMMIT" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT

      - name: Checkout infrastructure repository
        uses: actions/checkout@v4
        with:
          repository: anchoo2kewl/biswas-infrastructure
          path: biswas-infrastructure
          ssh-key: ${{ secrets.INFRA_SSH_PRIVATE_KEY }}

      - name: Setup SSH for deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.UAT_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan 92.4.83.28 >> ~/.ssh/known_hosts

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Deploy to UAT using Ansible
        env:
          COMMIT_SHA: ${{ github.sha }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          GIT_COMMIT: ${{ steps.version.outputs.GIT_COMMIT }}
          BUILD_TIME: ${{ steps.version.outputs.BUILD_TIME }}
        run: |
          cd biswas-infrastructure/ansible
          ansible-playbook \
            -i inventory/uat.yml \
            playbooks/deploy-taskai-uat.yml \
            -e "commit_sha=$COMMIT_SHA" \
            -e "version=$VERSION" \
            -e "git_commit=$GIT_COMMIT" \
            -e "build_time=$BUILD_TIME"

      - name: Verify deployment
        run: |
          sleep 10
          curl -f https://uat.taskai.cc/api/health || exit 1
          echo "âœ… UAT deployed successfully"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ UAT Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** 92.4.83.28" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://uat.taskai.cc" >> $GITHUB_STEP_SUMMARY
