name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy'
        required: false
        default: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production

    steps:
      - name: Display deployment info
        run: |
          echo "Deploying to PRODUCTION"
          echo "Ref: ${{ github.event.inputs.ref }}"
          echo "Triggered by: ${{ github.actor }}"

      - name: Trigger production webhook
        run: |
          echo "=== Deploying TaskAI to PRODUCTION ==="
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "https://taskai.cc/webhook/taskai" \
            -H "X-Hub-Signature-256: sha256=$(echo -n '{}' | openssl dgst -sha256 -hmac '${{ secrets.PRODUCTION_WEBHOOK_SECRET }}' | awk '{print $2}')" \
            -H "X-GitHub-Event: push" \
            -H "Content-Type: application/json" \
            -d '{}')
          echo "Webhook response: $RESPONSE"
          if [ "$RESPONSE" -lt 200 ] || [ "$RESPONSE" -ge 300 ]; then
            echo "WARNING: Webhook returned $RESPONSE, deployment may not have triggered"
          fi

      - name: Wait for deployment
        run: |
          echo "Waiting 60 seconds for deployment to complete..."
          sleep 60

      - name: Verify production health
        run: |
          echo "-> Checking API health..."
          for i in $(seq 1 30); do
            if curl -sf https://taskai.cc/api/health > /dev/null 2>&1; then
              echo "OK: API is healthy"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "FAIL: API health check failed"
              exit 1
            fi
            sleep 5
          done

          echo "-> Checking web health..."
          for i in $(seq 1 30); do
            if curl -sf -o /dev/null https://taskai.cc/ 2>&1; then
              echo "OK: Web is healthy"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "FAIL: Web health check failed"
              exit 1
            fi
            sleep 5
          done

          echo "-> Checking MCP health..."
          for i in $(seq 1 10); do
            if curl -sf https://mcp.taskai.cc/health > /dev/null 2>&1; then
              echo "OK: MCP is healthy"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "WARNING: MCP health check failed (non-blocking)"
            fi
            sleep 3
          done

          echo ""
          echo "=== Production deployment completed! ==="
          echo "URL: https://taskai.cc"
